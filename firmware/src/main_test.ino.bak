#include <Arduino.h>
#include <stdint.h>
#include <WiFi.h>
#include <PubSubClient.h>
#include <WiFiClientSecure.h>

// Test MQTT Configuration
#define WIFI_SSID "YOUR_WIFI_SSID"  // Change this
#define WIFI_PASSWORD "YOUR_WIFI_PASSWORD"  // Change this

#define MQTT_HOST "3bde4a57fee14109aa72d3b805d645c5.s1.eu.hivemq.cloud"
#define MQTT_PORT 8883
#define MQTT_USERNAME "avivais"
#define MQTT_PASSWORD "Avivr_121"

#define MQTT_TOPIC_INCOMING "test-incoming"
#define MQTT_TOPIC_SENT "test-sent-message"

// MQTT Client
WiFiClientSecure secureClient;
PubSubClient mqttClient(secureClient);

unsigned long lastPublishTime = 0;
const unsigned long PUBLISH_INTERVAL = 5000; // Publish every 5 seconds
int messageCount = 0;

void setup() {
    Serial.begin(115200);
    delay(1000);

    Serial.println("========================================");
    Serial.println("MQTT Test Firmware");
    Serial.println("========================================");

    // Connect to WiFi
    Serial.print("Connecting to WiFi: ");
    Serial.println(WIFI_SSID);

    WiFi.mode(WIFI_STA);
    WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }

    Serial.println();
    Serial.println("WiFi connected!");
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());

    // Configure MQTT with TLS
    // Note: For HiveMQ Cloud, we need to set the root CA certificate
    // For testing, we can skip certificate validation (not recommended for production)
    secureClient.setInsecure(); // Skip certificate validation for testing

    mqttClient.setServer(MQTT_HOST, MQTT_PORT);
    mqttClient.setCallback(onMqttMessage);
    mqttClient.setKeepAlive(60);
    mqttClient.setSocketTimeout(5);

    Serial.println("MQTT client configured");
}

void loop() {
    unsigned long now = millis();

    // Maintain WiFi connection
    if (WiFi.status() != WL_CONNECTED) {
        Serial.println("WiFi disconnected, reconnecting...");
        WiFi.reconnect();
        delay(1000);
        return;
    }

    // Maintain MQTT connection
    if (!mqttClient.connected()) {
        connectMqtt();
    } else {
        mqttClient.loop();

        // Publish test message every PUBLISH_INTERVAL
        if (now - lastPublishTime >= PUBLISH_INTERVAL) {
            publishTestMessage();
            lastPublishTime = now;
        }
    }

    delay(10);
}

void connectMqtt() {
    Serial.print("Connecting to MQTT broker: ");
    Serial.print(MQTT_HOST);
    Serial.print(":");
    Serial.println(MQTT_PORT);

    String clientId = "esp32_test_" + String(random(0xffff), HEX);

    if (mqttClient.connect(clientId.c_str(), MQTT_USERNAME, MQTT_PASSWORD)) {
        Serial.println("MQTT connected!");

        // Subscribe to incoming topic
        if (mqttClient.subscribe(MQTT_TOPIC_INCOMING, 1)) {
            Serial.print("Subscribed to: ");
            Serial.println(MQTT_TOPIC_INCOMING);
        } else {
            Serial.println("Failed to subscribe!");
        }
    } else {
        Serial.print("MQTT connection failed, rc=");
        Serial.println(mqttClient.state());
        delay(2000);
    }
}

void onMqttMessage(char* topic, uint8_t* payload, unsigned int length) {
    // Create null-terminated string from payload
    char message[length + 1];
    memcpy(message, payload, length);
    message[length] = '\0';

    Serial.println("========================================");
    Serial.print("Message received on topic: ");
    Serial.println(topic);
    Serial.print("Payload: ");
    Serial.println(message);
    Serial.print("Length: ");
    Serial.println(length);
    Serial.println("========================================");
}

void publishTestMessage() {
    if (!mqttClient.connected()) {
        return;
    }

    messageCount++;

    // Create test message
    String message = "Test message #" + String(messageCount) + " from ESP32 at " + String(millis());

    if (mqttClient.publish(MQTT_TOPIC_SENT, message.c_str(), false)) {
        Serial.print("[PUBLISH] Sent to ");
        Serial.print(MQTT_TOPIC_SENT);
        Serial.print(": ");
        Serial.println(message);
    } else {
        Serial.println("[PUBLISH] Failed to publish message");
    }
}

