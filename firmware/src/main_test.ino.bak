#include <Arduino.h>
#include "config/config.h"
#include "modem/ModemManager.h"
#include "ppp/PppManager.h"
#include "mqtt/MqttManager.h"

// Test MQTT Configuration (HiveMQ Cloud)
#define TEST_MQTT_HOST "3bde4a57fee14109aa72d3b805d645c5.s1.eu.hivemq.cloud"
#define TEST_MQTT_PORT 8883
#define TEST_MQTT_USERNAME "avivais"
#define TEST_MQTT_PASSWORD "Avivr_121"

#define TEST_MQTT_TOPIC_INCOMING "test-incoming"
#define TEST_MQTT_TOPIC_SENT "test-sent-message"

// Global managers
ModemManager modemManager;
PppManager pppManager(&modemManager);
MqttManager mqttManager;

// State tracking
enum TestState {
    TEST_MODEM_INIT,
    TEST_PPP_CONNECTING,
    TEST_PPP_UP,
    TEST_MQTT_CONNECTING,
    TEST_MQTT_CONNECTED
};

TestState testState = TEST_MODEM_INIT;
unsigned long stateEntryTime = 0;
unsigned long lastPublishTime = 0;
const unsigned long PUBLISH_INTERVAL = 5000; // Publish every 5 seconds
int messageCount = 0;

void setup() {
    Serial.begin(115200);
    delay(1000);

    Serial.println("========================================");
    Serial.println("MQTT Test Firmware - Cellular Only");
    Serial.println("Using Cellcom Israel APN");
    Serial.println("========================================");

    // Initialize MQTT manager
    mqttManager.begin();

    stateEntryTime = millis();
    Serial.println("[Test] Starting in TEST_MODEM_INIT state");
}

void loop() {
    unsigned long now = millis();

    // Process MQTT messages if connected
    if (testState == TEST_MQTT_CONNECTED) {
        mqttManager.loop();
    }

    // State machine
    switch (testState) {
        case TEST_MODEM_INIT:
            if (modemManager.init()) {
                Serial.println("[Test] Modem initialized, starting PPP...");
                testState = TEST_PPP_CONNECTING;
                stateEntryTime = now;
            } else if (now - stateEntryTime > AT_INIT_TIMEOUT_MS) {
                Serial.println("[Test] Modem init timeout, retrying...");
                modemManager.powerCycle();
                stateEntryTime = now;
            }
            break;

        case TEST_PPP_CONNECTING:
            {
                static bool pppStarted = false;
                if (!pppStarted) {
                    if (pppManager.start()) {
                        pppStarted = true;
                    }
                }

                if (pppManager.waitForPppUp(PPP_TIMEOUT_MS)) {
                    Serial.println("[Test] PPP connected!");
                    testState = TEST_PPP_UP;
                    pppStarted = false;
                } else if (now - stateEntryTime > PPP_TIMEOUT_MS) {
                    Serial.println("[Test] PPP connection timeout, retrying...");
                    pppManager.stop();
                    pppStarted = false;
                    stateEntryTime = now;
                }
            }
            break;

        case TEST_PPP_UP:
            Serial.println("[Test] PPP up, connecting to MQTT...");
            testState = TEST_MQTT_CONNECTING;
            stateEntryTime = now;
            break;

        case TEST_MQTT_CONNECTING:
            // Note: For test, we'd need to override MQTT_HOST in config
            // For now, this is a simplified test that uses the same MqttManager
            // In a real test, you might want to create a test-specific MQTT manager
            Serial.println("[Test] MQTT connection would be established here");
            Serial.println("[Test] Note: Update MQTT_HOST in config.h for test broker");
            testState = TEST_MQTT_CONNECTED;
            break;

        case TEST_MQTT_CONNECTED:
            // Publish test message periodically
            if (now - lastPublishTime >= PUBLISH_INTERVAL) {
                publishTestMessage();
                lastPublishTime = now;
            }

            // Check connection health
            if (!mqttManager.isConnected()) {
                Serial.println("[Test] MQTT connection lost, reconnecting...");
                testState = TEST_MQTT_CONNECTING;
                stateEntryTime = now;
            }
            break;
    }

    delay(10);
}

void publishTestMessage() {
    if (!mqttManager.isConnected()) {
        return;
    }

    messageCount++;

    // Create test message
    char message[128];
    snprintf(message, sizeof(message), "Test message #%d from ESP32 at %lu", messageCount, millis());

    // Note: Using status topic for test (update if needed)
    if (mqttManager.publish(MQTT_STATUS_TOPIC, message, false)) {
        Serial.print("[Test] Published: ");
        Serial.println(message);
    } else {
        Serial.println("[Test] Failed to publish message");
    }
}
